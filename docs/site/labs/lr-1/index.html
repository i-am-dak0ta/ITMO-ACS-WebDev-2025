
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../..">
      
      
        <link rel="next" href="../../practices/pr-1/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.49">
    
    
      
        <title>lr-1 - Web Programming Docs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.6f8fc17f.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#1-fastapi" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Web Programming Docs" class="md-header__button md-logo" aria-label="Web Programming Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Web Programming Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              lr-1
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Web Programming Docs" class="md-nav__button md-logo" aria-label="Web Programming Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Web Programming Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    lr-1
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    lr-1
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      Цели
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      Практическая часть
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Практическая часть">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      Описание приложения на тему "Разработка сервиса для управления личными финансами"
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Описание приложения на тему "Разработка сервиса для управления личными финансами"">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      Структура базы данных
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      Реализация кода
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Реализация кода">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#connectionpy" class="md-nav__link">
    <span class="md-ellipsis">
      Подключение к базе данных (connection.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mainpy" class="md-nav__link">
    <span class="md-ellipsis">
      Главный файл приложения (main.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modelspy" class="md-nav__link">
    <span class="md-ellipsis">
      Модели базы данных (models.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pydantic-schemaspy" class="md-nav__link">
    <span class="md-ellipsis">
      Схемы Pydantic (schemas.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#routersauthpy" class="md-nav__link">
    <span class="md-ellipsis">
      Маршруты авторизации (routers/auth.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#routersuserspy" class="md-nav__link">
    <span class="md-ellipsis">
      Маршруты пользователей (routers/users.py)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      Выполнение требований задания
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      Результат
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../practices/pr-1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pr-1
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../practices/pr-2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pr-2
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../practices/pr-3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pr-3
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      Цели
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      Практическая часть
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Практическая часть">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      Описание приложения на тему "Разработка сервиса для управления личными финансами"
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Описание приложения на тему "Разработка сервиса для управления личными финансами"">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      Структура базы данных
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      Реализация кода
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Реализация кода">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#connectionpy" class="md-nav__link">
    <span class="md-ellipsis">
      Подключение к базе данных (connection.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mainpy" class="md-nav__link">
    <span class="md-ellipsis">
      Главный файл приложения (main.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modelspy" class="md-nav__link">
    <span class="md-ellipsis">
      Модели базы данных (models.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pydantic-schemaspy" class="md-nav__link">
    <span class="md-ellipsis">
      Схемы Pydantic (schemas.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#routersauthpy" class="md-nav__link">
    <span class="md-ellipsis">
      Маршруты авторизации (routers/auth.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#routersuserspy" class="md-nav__link">
    <span class="md-ellipsis">
      Маршруты пользователей (routers/users.py)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      Выполнение требований задания
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      Результат
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="1-fastapi">Лабораторная работа 1. Реализация серверного приложения FastAPI</h1>
<h2 id="_1">Цели</h2>
<p>Научится реализовывать полноценное серверное приложение с помощью фреймворка FastAPI с применением дополнительных средств и библиотек.</p>
<h2 id="_2">Практическая часть</h2>
<h3 id="_3">Описание приложения на тему "Разработка сервиса для управления личными финансами"</h3>
<h4 id="_4">Структура базы данных</h4>
<p><img alt="Схема БД" src="../../assets/lr-1/DB_Schema.jpg" /></p>
<p>Модель данных включает 8 таблиц:
1. Users - пользователи.
2. TransactionTypes - типы транзакций.
3. Categories - категории транзакций.
4. Budgets - бюджеты пользователей.
5. Goals - финансовые цели.
6. Notifications - уведомления.
7. Tags - теги для транзакций.
8. Transactions - транзакции.</p>
<p>Связи:
- One-to-Many: <code>Users</code> → <code>Transactions</code>, <code>Users</code> → <code>Budgets</code>, <code>Users</code> → <code>Goals</code>, <code>Users</code> → <code>Notifications</code>.
- Many-to-Many: <code>Transactions</code> ↔ <code>Tags</code> через ассоциативную таблицу <code>TransactionTags</code>.
- Ассоциативная сущность: <code>TransactionTags</code> содержит поле <code>transaction_tag_id</code> помимо внешних ключей, что соответствует требованиям задания.</p>
<h3 id="_5">Реализация кода</h3>
<h4 id="connectionpy">Подключение к базе данных (<code>connection.py</code>)</h4>
<p>Файл настраивает подключение к базе данных и инициализирует таблицы:</p>
<pre><code class="language-python">import os  
from dotenv import load_dotenv  
from sqlmodel import SQLModel, Session, create_engine  

load_dotenv()  
db_url = os.getenv(&quot;DB_ADMIN&quot;)  
engine = create_engine(db_url, echo=True)  

def init_db():  
    SQLModel.metadata.create_all(engine)  

def get_session():  
    with Session(engine) as session:  
        yield session
</code></pre>
<h4 id="mainpy">Главный файл приложения (<code>main.py</code>)</h4>
<p>Создаёт приложение FastAPI, подключает маршруты и инициализирует базу данных при запуске:</p>
<pre><code class="language-python">from fastapi import FastAPI  
from connection import init_db  
from routers import auth, users  

app = FastAPI()  

@app.on_event(&quot;startup&quot;)  
def on_startup():  
    init_db()  

app.include_router(users.router)  
app.include_router(auth.router)  

@app.get(&quot;/&quot;)  
def hello():  
    return &quot;Hello, Artur!&quot;
</code></pre>
<h4 id="modelspy">Модели базы данных (<code>models.py</code>)</h4>
<p>Определены модели с учётом связей (приведён фрагмент для <code>Users</code>):</p>
<pre><code class="language-python">from typing import Optional, List  
from sqlmodel import SQLModel, Field, Relationship  

class Users(SQLModel, table=True):  
    user_id: Optional[int] = Field(default=None, primary_key=True)  
    username: str = Field(index=True, unique=True)  
    password: str  
    first_name: str  
    last_name: str  
    email: str = Field(unique=True, index=True)  

    transactions: List[&quot;Transactions&quot;] = Relationship(back_populates=&quot;user&quot;)  
    budgets: List[&quot;Budgets&quot;] = Relationship(back_populates=&quot;user&quot;)  
    goals: List[&quot;Goals&quot;] = Relationship(back_populates=&quot;goals&quot;)  
    notifications: List[&quot;Notifications&quot;] = Relationship(back_populates=&quot;user&quot;)
</code></pre>
<h4 id="pydantic-schemaspy">Схемы Pydantic (<code>schemas.py</code>)</h4>
<p>Определены модели для валидации данных:</p>
<pre><code class="language-python">from pydantic import BaseModel, EmailStr  
from typing import Optional  

class UserBase(BaseModel):  
    username: str  
    first_name: str  
    last_name: str  
    email: EmailStr  

class UserCreate(UserBase):  
    password: str  

class UserRead(UserBase):  
    user_id: int  
    class Config:  
        from_attributes = True  

class UserWithToken(BaseModel):  
    user: UserRead  
    access_token: str  
    token_type: str = &quot;bearer&quot;  

class UserLogin(BaseModel):  
    username: str  
    password: str  

class UserPassword(BaseModel):  
    old_password: str  
    new_password: str
</code></pre>
<h4 id="routersauthpy">Маршруты авторизации (<code>routers/auth.py</code>)</h4>
<p>Реализованы функции регистрации, логина, проверки токенов и управления паролем:</p>
<pre><code class="language-python">import datetime  
import os  
import jwt  
from fastapi import APIRouter, HTTPException, Depends, Security, status  
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials  
from sqlmodel import Session, select  
from passlib.context import CryptContext  
from connection import get_session  
from models import Users  
from schemas import UserCreate, UserRead, UserLogin, UserPassword, UserWithToken  

router = APIRouter(prefix=&quot;/auth&quot;, tags=[&quot;Authentication&quot;])  

SECRET_KEY = os.getenv(&quot;SECRET_KEY&quot;)  
ALGORITHM = os.getenv(&quot;ALGORITHM&quot;)  
ACCESS_TOKEN_EXPIRE_MINUTES = 30  

pwd_context = CryptContext(schemes=[&quot;bcrypt&quot;], deprecated=&quot;auto&quot;)  
auth_scheme = HTTPBearer()  

def create_access_token(data: dict, expires_delta: datetime.timedelta = None) -&gt; str:  
    payload = data.copy()  
    if expires_delta:  
        expire = datetime.datetime.now(datetime.timezone.utc) + expires_delta  
    else:  
        expire = datetime.datetime.now(datetime.timezone.utc) + datetime.timedelta(  
            minutes=ACCESS_TOKEN_EXPIRE_MINUTES  
        )  
    payload.update({&quot;exp&quot;: expire})  
    encoded_jwt = jwt.encode(payload, SECRET_KEY, algorithm=ALGORITHM)  
    return encoded_jwt  

def verify_token(token: str) -&gt; str:  
    try:  
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])  
        return payload.get(&quot;sub&quot;)  
    except jwt.ExpiredSignatureError:  
        raise HTTPException(status_code=status.HTTP_401_UNAUTHORIZED, detail=&quot;Token expired&quot;)  
    except jwt.InvalidTokenError:  
        raise HTTPException(status_code=status.HTTP_401_UNAUTHORIZED, detail=&quot;Invalid token&quot;)  

def create_user_with_hash(user_create: UserCreate, session: Session) -&gt; Users:  
    username_statement = select(Users).where(Users.username == user_create.username)  
    existing_user = session.exec(username_statement).first()  
    if existing_user:  
        raise HTTPException(status_code=400, detail=&quot;Username already registered&quot;)  
    email_statement = select(Users).where(Users.email == user_create.email)  
    existing_email = session.exec(email_statement).first()  
    if existing_email:  
        raise HTTPException(status_code=400, detail=&quot;Email already registered&quot;)  
    hashed_password = pwd_context.hash(user_create.password)  
    new_user = Users(  
        username=user_create.username,  
        password=hashed_password,  
        first_name=user_create.first_name,  
        last_name=user_create.last_name,  
        email=user_create.email  
    )  
    session.add(new_user)  
    session.commit()  
    session.refresh(new_user)  
    return new_user  

def create_user_and_token(user_create: UserCreate, session: Session) -&gt; dict:  
    user = create_user_with_hash(user_create, session)  
    token = create_access_token(data={&quot;sub&quot;: user.username})  
    return {  
        &quot;user&quot;: UserRead.model_validate(user),  
        &quot;access_token&quot;: token,  
        &quot;token_type&quot;: &quot;bearer&quot;  
    }  

@router.post(&quot;/register&quot;, response_model=UserWithToken)  
def register(user_create: UserCreate, session: Session = Depends(get_session)):  
    return create_user_and_token(user_create, session)  

@router.post(&quot;/login&quot;, response_model=UserWithToken)  
def login(user_login: UserLogin, session: Session = Depends(get_session)):  
    statement = select(Users).where(Users.username == user_login.username)  
    user = session.exec(statement).first()  
    if not user or not pwd_context.verify(user_login.password, user.password):  
        raise HTTPException(status_code=401, detail=&quot;Invalid credentials&quot;)  
    token = create_access_token(data={&quot;sub&quot;: user.username})  
    return {  
        &quot;user&quot;: UserRead.model_validate(user),  
        &quot;access_token&quot;: token,  
        &quot;token_type&quot;: &quot;bearer&quot;  
    }  

def get_current_user(  
    credentials: HTTPAuthorizationCredentials = Security(auth_scheme),  
    session: Session = Depends(get_session)  
) -&gt; Users:  
    token = credentials.credentials  
    username = verify_token(token)  
    statement = select(Users).where(Users.username == username)  
    user = session.exec(statement).first()  
    if not user: raise HTTPException(status_code=404, detail=&quot;User not found&quot;)  
    return user  

@router.get(&quot;/me&quot;, response_model=UserRead)  
def read_current_user(current_user: Users = Depends(get_current_user)):  
    return current_user  

@router.patch(&quot;/change-password&quot;)  
def change_password(  
    pwd_data: UserPassword,  
    current_user: Users = Depends(get_current_user),  
    session: Session = Depends(get_session)  
):  
    if not pwd_context.verify(pwd_data.old_password, current_user.password):  
        raise HTTPException(status_code=400, detail=&quot;Incorrect current password&quot;)  
    current_user.password = pwd_context.hash(pwd_data.new_password)  
    session.add(current_user)  
    session.commit()  
    return {&quot;message&quot;: &quot;Password updated successfully&quot;}
</code></pre>
<h4 id="routersuserspy">Маршруты пользователей (<code>routers/users.py</code>)</h4>
<p>Реализованы CRUD-операции для пользователей:</p>
<pre><code class="language-python">from fastapi import APIRouter, Depends, HTTPException  
from sqlmodel import Session, select  
from connection import get_session  
from models import Users  
from routers.auth import create_user_and_token  
from schemas import UserCreate, UserRead, UserUpdate, UserWithToken  

router = APIRouter(prefix=&quot;/users&quot;, tags=[&quot;Users&quot;])  

@router.post(&quot;/&quot;, response_model=UserWithToken)  
def create_user(user_create: UserCreate, session: Session = Depends(get_session)):  
    return create_user_and_token(user_create, session)  

@router.get(&quot;/&quot;, response_model=list[UserRead])  
def read_users(session: Session = Depends(get_session)):  
    users = session.exec(select(Users)).all()  
    return users  

@router.get(&quot;/{user_id}&quot;, response_model=UserRead)  
def read_user(user_id: int, session: Session = Depends(get_session)):  
    user = session.get(Users, user_id)  
    if not user:  
        raise HTTPException(status_code=404, detail=&quot;User not found&quot;)  
    return user  

@router.patch(&quot;/{user_id}&quot;, response_model=UserRead)  
def update_user(user_id: int, user_update: UserUpdate, session: Session = Depends(get_session)):  
    user = session.get(Users, user_id)  
    if not user:  
        raise HTTPException(status_code=404, detail=&quot;User not found&quot;)  
    user_data = user_update.dict(exclude_unset=True)  
    for key, value in user_data.items():  
        setattr(user, key, value)  
    session.add(user)  
    session.commit()  
    session.refresh(user)  
    return user  

@router.delete(&quot;/{user_id}&quot;)  
def delete_user(user_id: int, session: Session = Depends(get_session)):  
    user = session.get(Users, user_id)  
    if not user:  
        raise HTTPException(status_code=404, detail=&quot;User not found&quot;)  
    session.delete(user)  
    session.commit()  
    return {&quot;message&quot;: &quot;User deleted successfully&quot;}
</code></pre>
<h3 id="_6">Выполнение требований задания</h3>
<ol>
<li>Авторизация и регистрация:<ul>
<li>Реализованы через <code>POST /auth/register</code> и <code>POST /auth/login</code>. После регистрации пользователь сразу получает JWT-токен.</li>
</ul>
</li>
<li>Генерация JWT-токенов:<ul>
<li>Функция <code>create_access_token</code> создаёт токены с использованием библиотеки <code>jwt</code>.</li>
</ul>
</li>
<li>Аутентификация по JWT-токену:<ul>
<li>Реализована вручную через <code>verify_token</code>, без сторонних библиотек для проверки токена.</li>
</ul>
</li>
<li>Хэширование паролей:<ul>
<li>Используется <code>passlib</code> с алгоритмом <code>bcrypt</code> для безопасного хранения паролей.</li>
</ul>
</li>
<li>Дополнительные API-методы:<ul>
<li><code>GET /auth/me</code> - получение данных текущего пользователя.</li>
<li><code>GET /users/</code> - список всех пользователей.</li>
<li><code>PATCH /auth/change-password</code> - смена пароля.</li>
</ul>
</li>
</ol>
<h2 id="_7">Результат</h2>
<p>Приложение успешно реализует базовый функционал управления пользователями для сервиса личных финансов. Все требования задания выполнены:
- Создана модель данных с более чем 5 таблицами, включая связи one-to-many и many-to-many.
- Реализована авторизация с JWT-токенами вручную.
- Эндпоинты протестированы и доступны через документацию FastAPI.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.88dd0f4e.min.js"></script>
      
    
  </body>
</html>